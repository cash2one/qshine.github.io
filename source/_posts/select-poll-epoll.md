---
title: select/poll/epoll学习笔记
date: 2017-11-02 22:29:38
categories: web框架
tags:
  - tornado
  - 操作系统
---


学习tornado中, 看了很多关于epoll的资料, 强烈建议读最后的文章链接, 作者针对很多概念总结的非常好了, 我只是记录下认为比较重要的部分


> select，poll，epoll都是IO多路复用的机制。I/O多路复用就是通过一种机制，一个进程可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。但select，poll，epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的，而异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间

### I/O多路复用
I/O多路复用的特点是通过一种机制使一个进程能同时等待多个文件描述符, 而这些文件描述符其中的任意一个进入读就绪状态, select()函数就可以返回

### select缺点
1. 每次调用select，都需要把fd集合从用户态拷贝到内核态，这个开销在fd很多时会很大
2. 同时每次调用select都需要在内核遍历传递进来的所有fd，这个开销在fd很多时也很大
3. select支持的文件描述符数量太小了，默认是1024

### poll
**poll**和**select**类似, 管理多个描述符也是进行轮询, 根据描述符的状态进行处理, **但是poll没有最大文件描述符数量的限制**

poll和select的同一个缺点: 包含大量的文件描述符的集合要被从用户态拷贝到内核态, 不论这些描述符是否就绪, 开销会随着数量的增加而增大

### epoll
> 在 select/poll中，进程只有在调用一定的方法后，内核才对所有监视的文件描述符进行扫描，而epoll事先通过epoll_ctl()来注册一 个文件描述符，一旦基于某个文件描述符就绪时，内核会采用类似callback的回调机制，迅速激活这个文件描述符，当进程调用epoll_wait() 时便得到通知。(此处去掉了遍历文件描述符，而是通过监听回调的的机制。这正是epoll的魅力所在。)

1. **针对select和poll每次都要拷贝所有的fd问题**, epoll在`epoll_ctl`函数中。每次注册新的事件到epoll句柄中时（在epoll_ctl中指定EPOLL_CTL_ADD），会把所有的fd拷贝进内核，而不是在epoll_wait的时候重复拷贝。epoll保证了每个fd在整个过程中只会拷贝一次.
2. **针对select和poll每次在内核态遍历所有的fd问题**, epoll在`epoll_ctl`时为每个fd指定一个回调函数, 当某个fd就绪, 会调用这个回调函数, 这个回调函数会把就绪的fd加入一个就绪链表, epoll_wait会直接检查这个就绪链表
3. epoll没有fd的数量限制, 在1GB内存机器一般为10w

### 资料
- [Linux IO模式及 select、poll、epoll详解](https://segmentfault.com/a/1190000003063859)
- [select、poll、epoll之间的区别总结](http://www.cnblogs.com/Anker/p/3265058.html)