---
title: Django使用已存在表
date: 2017-10-18 21:34:03
categories: Web后端
tags:
  - Django
---


**场景:** 使用已存在的数据表来生成`models.py`, 增加主键自增id

### 一. 生成models.py
修改settings中的数据库连接和app
```
python manage.py inspectdb > models.py
```
会把使用的库的所有表生成到`models.py`中, 选择要使用的代码复制到app的models中, 类似如下
```python
class Student(models.Model):
    name = models.CharField(max_length=100, blank=True, null=True)
    age = models.IntegerField(blank=True, null=True)

    class Meta:
        managed = False    
        db_table = 'student'
```
`managed = False`表示不能被后台管理, 所以将这行删掉

### 二. 生成迁移文件
1. `python manage.py makemigrations`生成迁移文件
    ```python
    # -*- coding: utf-8 -*-
    # Generated by Django 1.9.13 on 2017-10-18 13:48
    from __future__ import unicode_literals
    
    from django.db import migrations, models
    
    
    class Migration(migrations.Migration):
    
        initial = True
    
        dependencies = [
        ]
    
        operations = [
            migrations.CreateModel(
                name='Student',
                fields=[
                    ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                    ('name', models.CharField(blank=True, max_length=100, null=True)),
                    ('age', models.IntegerField(blank=True, null=True)),
                ],
                options={
                    'db_table': 'student',
                },
            ),
        ]

    ```

2. `python manage.py migrate`执行迁移
    此时会报表已存在的错误, 此时再次执行
    ```
    python manage.py migrate --fake
    ```
    此时已经映射成功了, 但是数据表中没有id字段
    **注:** 不要打乱这两句的执行顺序, 否则会报另一种错误
    
### 三. 生成id字段
1. 在models.py中加入代码
    ```python
    id = models.AutoField(primary_key=True)
    ```
2. 删除迁移文件的29行, 因为Django的ORM默认会给没有主键的models生成`id主键(自增)`, 可参考(http://python.jobbole.com/88672/)
3. 再次执行迁移
    ```
    python manage.py makemigrations    # 生成新的迁移文件
    python manage.py migrate    # 执行迁移
    ```
    此时数据表添加了`id字段`
    

### 资料
- [官方文档](https://docs.djangoproject.com/en/1.11/ref/django-admin/#inspectdb)
- [伯乐在线](http://python.jobbole.com/88672/)
    

